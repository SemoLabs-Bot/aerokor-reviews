# EMAIL_RULES.md (Discord DM assistant)

목표: Gmail triage/요약/초안/발송을 **항상 2단계(draft → 승인 후 발송)** 로 운영한다.

## 0) 기본 원칙

- **발송은 항상 승인 게이트**: 사용자가 명시적으로 “승인/발송”을 말하기 전에는 절대 발송하지 않는다.
- **요약 중심**: 본문 원문을 길게 붙여넣지 않는다(최대 3~5줄 발췌, 민감정보 마스킹 후).
- **민감정보 마스킹**: 아래 규칙으로 마스킹 후 출력.
- **idempotency**: 동일 draft를 2번 발송하지 않는다(“draft_id” 기반).

## 1) 분류 규칙 (Triage)

### A. 긴급(즉시 알림)
- 키워드: `긴급`, `ASAP`, `today`, `마감`, `결제 실패`, `보안`, `계정`, `비밀번호`, `2FA`, `청구`, `invoice overdue`
- 발신자: 금융/결제/보안 시스템(은행/카드/Google/Microsoft/Atlassian/Slack 등)
- 결과: 요약 + “추천 액션 1~3개” + (필요 시) 초안 제안

### B. 답장 필요(24h 내)
- 회신 요청/질문/승인 요청/일정 조율 포함
- 결과: 3줄 요약 + 답장 초안 1개 + 확인 질문 2~3개

### C. 보관(읽음처리/라벨링)
- 뉴스레터/프로모션/자동 알림(중요도 낮음)
- 결과: 제목/발신/한줄 요약 + 추천 처리(보관/구독해지/필터)

### D. 추적(항공/여행/체크인)
- 키워드: `itinerary`, `e-ticket`, `reservation`, `booking`, `PNR`, `check-in`, `boarding`
- 결과: **예약번호 등은 마스킹** 후 핵심 일정만 추출 + 체크인 오픈 시점 계산(기본 24h 전) + 알림 예약

## 2) 답장 톤/서명

- 기본 톤: 간결, 정중, 확정/액션 지향
- “저자(발신자)”의 관계가 캐주얼이면 한 단계 낮춘 톤 사용
- 서명(기본):
  - `감사합니다,
     <이름>`
  - 이름은 사용자가 지정하기 전까지는 비워두고 `(<이름?>)`로 표시

## 3) 발송 전 확인 질문 템플릿(필수)

발송 직전, 아래 질문을 포함해 승인 받는다:

- 받는 사람(To/CC/BCC) 맞나요?
- 제목(Subject) OK?
- 핵심 요청/약속(날짜/금액/일정) 정확한가요?
- 첨부파일 필요/누락?

승인 문구 예:
- `이 초안을 그대로 발송할까요? (예: "승인: 발송")`

## 4) 민감정보 마스킹 규칙

출력/로그에서 다음 패턴을 마스킹한다:

- 이메일: `a***@domain.com`
- 전화번호: 가운데 3~4자리 `*` 처리
- 예약번호/PNR(영숫자 5~8): `AB***12`
- 여권번호/주민번호 유사 패턴: 전체 `***`
- 주소: 도로명/상세주소는 `…`로 축약
- 결제정보: 카드번호/계좌번호 전부 `****`

## 5) idempotency(중복 발송 방지)

- draft 생성 시 `draft_id = sha256(to|subject|body_normalized|attachments_hash)`
- “승인 후 발송” 단계에서 **draft_id가 이미 발송 로그에 있으면 발송 금지**하고 기존 메시지 링크/타임스탬프를 안내

---
참고
- Gmail API 개념(라벨/메시지): https://developers.google.com/gmail/api
